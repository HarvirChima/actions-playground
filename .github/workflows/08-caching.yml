# 08 - CACHING DEPENDENCIES
# Speed up workflows with actions/cache (npm, pip, Go, Gradle, Maven)
# Limits: 10GB/repo, 7-day expiry, branch-scoped with default branch fallback

name: 08 - Caching Dependencies

on:
  push:
    branches: [ main, copilot/** ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # NPM CACHE
  cache-npm:
    name: Cache NPM Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      # hashFiles() invalidates cache when lockfile changes
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-
      - name: Install dependencies (if not cached)
        run: echo "npm install - much faster with cache hit!"

  # PIP CACHE
  cache-pip:
    name: Cache Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install dependencies (if not cached)
        run: echo "pip install - faster with cache"

  # GO CACHE
  cache-go:
    name: Cache Go Modules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-
      - name: Download Go modules (if not cached)
        run: echo "go mod download - faster with cache"

  # GRADLE CACHE
  cache-gradle:
    name: Cache Gradle Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-
      - name: Build with Gradle (if not cached)
        run: echo "gradlew build - faster with cache"

  # MAVEN CACHE
  cache-maven:
    name: Cache Maven Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-maven-
      - name: Build with Maven (if not cached)
        run: echo "mvn install - faster with cache"
          
  # BUILD OUTPUT CACHE - commit SHA for unique builds
  cache-build-outputs:
    name: Cache Build Outputs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            dist
            build
            .next
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: ${{ runner.os }}-build-
      - name: Build project (if not cached)
        run: echo "Timestamp: $(date)" > build-output.txt

  # SEPARATE SAVE/RESTORE - advanced pattern for PRs
  cache-with-save-restore:
    name: Cache with Separate Save/Restore
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # Restore only (read-only for PRs)
      - name: Restore cache (read-only)
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: ~/.custom-cache
          key: ${{ runner.os }}-custom-v1
          restore-keys: ${{ runner.os }}-custom-
      - name: Perform some work
        run: |
          mkdir -p ~/.custom-cache
          echo "Result: $(date)" > ~/.custom-cache/result.txt
      # Save only on main (avoid cache pollution from PRs)
      - name: Save cache (only on main)
        uses: actions/cache/save@v4
        if: github.ref == 'refs/heads/main' && steps.cache-restore.outputs.cache-hit != 'true'
        with:
          path: ~/.custom-cache
          key: ${{ runner.os }}-custom-v1

  # CACHE KEY STRATEGIES REFERENCE
  cache-key-strategies:
    name: Cache Key Strategies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Demonstrate cache key strategies
        run: |
          echo "Key Strategies:"
          echo "1. hashFiles() - invalidate on lockfile change"
          echo "2. restore-keys - fallback to partial match"
          echo "3. github.sha - unique per commit"
          echo "4. github.ref_name - branch-specific"
          echo "5. v2-prefix - force invalidation"
