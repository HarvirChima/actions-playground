# =============================================================================
# 11 - BEST PRACTICES
# =============================================================================
# ðŸŽ¯ PURPOSE: Demonstrates GitHub Actions best practices for security,
# performance, maintainability, and reliability.
#
# ðŸ“š KEY CONCEPTS COVERED:
#   â€¢ Explicit permission settings
#   â€¢ Environment variables (global and local)
#   â€¢ Conditional execution (if statements)
#   â€¢ Setting and using outputs
#   â€¢ Error handling with continue-on-error
#   â€¢ Meaningful naming conventions
#
# âœ… BEST PRACTICES SUMMARY:
#
#   SECURITY:
#   â€¢ Set minimal permissions with 'permissions' key
#   â€¢ Pin actions to specific versions or commit SHAs
#   â€¢ Never expose secrets in logs
#   â€¢ Use CODEOWNERS for workflow file changes
#   â€¢ Review third-party actions before using
#
#   PERFORMANCE:
#   â€¢ Use caching for dependencies
#   â€¢ Use matrix builds for parallel testing
#   â€¢ Use concurrency to cancel outdated runs
#   â€¢ Use path filters to skip unnecessary runs
#
#   MAINTAINABILITY:
#   â€¢ Use meaningful names for jobs and steps
#   â€¢ Use reusable workflows for common patterns
#   â€¢ Group related commands in single steps
#   â€¢ Document complex logic with comments
#
#   RELIABILITY:
#   â€¢ Handle errors appropriately
#   â€¢ Set timeouts for long-running jobs
#   â€¢ Use conditionals to control execution flow
# =============================================================================

name: 11 - Best Practices

on:
  push:
    branches: [ main, copilot/** ]
  workflow_dispatch:

# =============================================================================
# BEST PRACTICE: EXPLICIT PERMISSIONS
# =============================================================================
# By default, workflows have broad permissions. Always restrict to minimum needed.
# This follows the security principle of least privilege.
#
# Available permissions:
#   actions, checks, contents, deployments, id-token, issues,
#   packages, pages, pull-requests, repository-projects, security-events,
#   statuses, etc.
#
# Values: 'read', 'write', or 'none'
permissions:
  contents: read

# =============================================================================
# GLOBAL ENVIRONMENT VARIABLES
# =============================================================================
# Define variables available to ALL jobs and steps in this workflow.
# Access with: $VARIABLE_NAME (shell) or ${{ env.VARIABLE_NAME }} (expressions)
env:
  PROJECT_NAME: actions-playground
  BUILD_NUMBER: ${{ github.run_number }}  # Dynamic value from GitHub context

jobs:
  best-practices-demo:
    name: Best Practices Demonstration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # -----------------------------------------------------------------------
      # BEST PRACTICE: PIN ACTION VERSIONS
      # -----------------------------------------------------------------------
      # Always specify a version when using actions:
      #   @v4 - Major version (recommended for balance of stability/updates)
      #   @v4.0.0 - Exact version (most predictable)
      #   @abc123def - Commit SHA (most secure, prevents tampering)
      - name: Setup Node.js (pinned version)
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      # -----------------------------------------------------------------------
      # BEST PRACTICE: USE ENVIRONMENT VARIABLES
      # -----------------------------------------------------------------------
      # Environment variables make workflows more maintainable and secure.
      # - Global env vars: Defined at workflow level
      # - Local env vars: Defined at step level (override global)
      - name: Use environment variables
        env:
          LOCAL_VAR: local-value  # Step-level env var
        run: |
          echo "Project: $PROJECT_NAME"   # Global env var
          echo "Build: $BUILD_NUMBER"     # Global env var with expression
          echo "Local: $LOCAL_VAR"        # Step-level env var
          
      # -----------------------------------------------------------------------
      # BEST PRACTICE: CONDITIONAL EXECUTION
      # -----------------------------------------------------------------------
      # Use 'if' to control when steps run.
      # This saves time and resources by skipping unnecessary work.
      - name: Run only on main branch
        if: github.ref == 'refs/heads/main'
        run: echo "This runs only on main branch"
        
      - name: Run only on pull requests
        if: github.event_name == 'pull_request'
        run: echo "This runs only on pull requests"
        
      # -----------------------------------------------------------------------
      # BEST PRACTICE: SET OUTPUTS FOR JOB COMMUNICATION
      # -----------------------------------------------------------------------
      # Use GITHUB_OUTPUT to pass data between steps.
      # Format: echo "name=value" >> $GITHUB_OUTPUT
      - name: Set output
        id: vars  # ID required to reference outputs
        run: |
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
          echo "short-sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          
      # Access outputs using: steps.<step-id>.outputs.<output-name>
      - name: Use output
        run: |
          echo "Timestamp: ${{ steps.vars.outputs.timestamp }}"
          echo "Short SHA: ${{ steps.vars.outputs.short-sha }}"
          
      # -----------------------------------------------------------------------
      # BEST PRACTICE: HANDLE ERRORS APPROPRIATELY
      # -----------------------------------------------------------------------
      # Use 'continue-on-error: true' for steps that might fail but shouldn't
      # stop the entire workflow (e.g., optional tests, notifications).
      - name: Continue on error example
        continue-on-error: true
        run: |
          echo "This step might fail, but workflow continues"
          exit 0
          
      # -----------------------------------------------------------------------
      # BEST PRACTICE: USE MEANINGFUL STEP NAMES
      # -----------------------------------------------------------------------
      # Good names describe WHAT the step does, making logs easier to read.
      # Bad:  "Step 1", "Run script"
      # Good: "Build application for production", "Run unit tests"
      - name: Build application for production
        run: echo "Building..."
        
      # -----------------------------------------------------------------------
      # BEST PRACTICE: GROUP RELATED COMMANDS
      # -----------------------------------------------------------------------
      # Keep related commands together in one step for clarity and efficiency.
      - name: Display all environment info
        run: |
          echo "=== Environment Information ==="
          echo "OS: $(uname -s)"
          echo "Runner: ${{ runner.os }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
  # ===========================================================================
  # SECURITY BEST PRACTICES JOB
  # ===========================================================================
  security-best-practices:
    name: Security Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Security considerations
        run: |
          echo "Security Best Practices:"
          echo "1. Pin actions to commit SHA or specific tags"
          echo "2. Never expose secrets in logs"
          echo "3. Use CODEOWNERS for workflow files"
          echo "4. Limit workflow permissions with 'permissions:' key"
          echo "   Example: permissions: { contents: read }"
          echo "5. Use environments for protection rules"
          echo "6. Review third-party actions before use"
          echo "7. Use verified creators when possible"
          echo "8. Enable security features (Dependabot, CodeQL)"
          
  # ===========================================================================
  # PERFORMANCE BEST PRACTICES JOB
  # ===========================================================================
  performance-best-practices:
    name: Performance Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Performance tips
        run: |
          echo "Performance Best Practices:"
          echo "1. Use caching for dependencies"
          echo "2. Use matrix builds for parallel execution"
          echo "3. Use concurrency to cancel outdated runs"
          echo "4. Optimize artifact sizes"
          echo "5. Use self-hosted runners for better performance"
          echo "6. Use path filters to skip unnecessary runs"
          echo "7. Use reusable workflows to avoid duplication"
